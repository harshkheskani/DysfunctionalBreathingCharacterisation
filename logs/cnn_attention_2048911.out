======================================================
Job started on landonia19.inf.ed.ac.uk at Wed 23 Jul 18:53:01 BST 2025
Job ID: 2048911
======================================================
Conda environment 'diss' activated.
Using python: /home/s1978431/miniconda3/envs/diss/bin/python
Changed to /home/s1978431/DysfunctionalBreathingCharacterisation
Starting Python script: /home/s1978431/DysfunctionalBreathingCharacterisation/src/Classification/attention_cnn_cluster.py
Data source: /home/s1978431/DysfunctionalBreathingCharacterisation/data/bishkek_csr/03_train_ready
Results will be saved to: /home/s1978431/DysfunctionalBreathingCharacterisation/results/cd2048911
--- 1. Setting up configuration and constants ---

--- 2. Loading and preprocessing data ---
Found 9 event files. Processing each one...
  - Processing session: 10-05-2025
  - Applying precise interval-based labels...
  - Processing session: 11-05-2025
  - Applying precise interval-based labels...
  - Processing session: 24-04-2025
  - Applying precise interval-based labels...
  - Processing session: 16-04-2025
  - Applying precise interval-based labels...
  - Processing session: 25-04-2025
  - Applying precise interval-based labels...
  - Processing session: 26-04-2025
  - Applying precise interval-based labels...
  - Processing session: 08-05-2025
  - Applying precise interval-based labels...
  - Processing session: 04-04-2025
  - Applying precise interval-based labels...
  - Processing session: 05-04-2025
  - Applying precise interval-based labels...

----------------------------------------------------
Data loading with PURE signals complete.
Final DataFrame shape: (2363398, 14)
Final class distribution in raw data: 
Label
0    0.883397
4    0.071997
2    0.036877
1    0.007303
3    0.000425
Name: proportion, dtype: float64

--- 3. Engineering features, imputing missing values, and normalizing ---
Engineering breathing-focused signal features...
Time-domain features added: ['breathing_signal_rolling_mean', 'breathing_signal_rolling_std', 'accel_magnitude']
Engineering breathing signal FFT features...
  - Computing comprehensive FFT features for breathing signal...
Breathing FFT features added: ['breathing_fft_power_very_low', 'breathing_fft_power_low', 'breathing_fft_power_normal_resp', 'breathing_fft_power_fast_resp', 'breathing_fft_power_high', 'breathing_fft_spectral_centroid', 'breathing_fft_spectral_spread', 'breathing_fft_dominant_frequency', 'breathing_fft_respiratory_regularity', 'breathing_fft_apnea_indicator']
Total new FFT features: 10

Checking for and imputing missing values (NaNs)...
  - Found 4762 NaNs in 'breathingSignal'. Applying forward-fill and backward-fill.
  - Found 2317390 NaNs in 'breathingRate'. Applying forward-fill and backward-fill.
  - Found 1954 NaNs in 'breathing_signal_rolling_mean'. Applying forward-fill and backward-fill.
  - Found 69018 NaNs in 'breathing_fft_power_very_low'. Applying forward-fill and backward-fill.
  - Found 69018 NaNs in 'breathing_fft_power_low'. Applying forward-fill and backward-fill.
  - Found 69018 NaNs in 'breathing_fft_power_normal_resp'. Applying forward-fill and backward-fill.
  - Found 69018 NaNs in 'breathing_fft_power_fast_resp'. Applying forward-fill and backward-fill.
  - Found 69018 NaNs in 'breathing_fft_power_high'. Applying forward-fill and backward-fill.

Imputation complete. No NaNs remain in feature columns.

Applying per-session (per-subject) normalization...
Normalization complete.

--- 4. Creating time-series windows ---
Number of classes: 5
Class names: ['Normal', 'Obstructive Apnea', 'Hypopnea Events', 'Central/Mixed Apnea', 'Desaturation']

Starting the windowing process on normalized data...

Data windowing complete.
----------------------------------------------------
Shape of X (features): (31897, 375, 19)
Shape of y (labels):   (31897,)
Shape of groups (IDs): (31897,)
Final class distribution across all windows: Counter({np.int64(0): 28206, np.int64(4): 2500, np.int64(2): 1034, np.int64(1): 151, np.int64(3): 6})

--- 5. Setting up PyTorch device ---
Using device: cuda

--- 6. Performing initial train-test split for preliminary check ---
Train-test split complete.
Training set class distribution: Counter({np.int64(0): 21974, np.int64(4): 1611, np.int64(2): 699, np.int64(1): 115, np.int64(3): 4})
Testing set class distribution:  Counter({np.int64(0): 6232, np.int64(4): 889, np.int64(2): 335, np.int64(1): 36, np.int64(3): 2})

Balancing the training data using SMOTE...
  - Original training distribution: Counter({np.int64(0): 21974, np.int64(4): 1611, np.int64(2): 699, np.int64(1): 115, np.int64(3): 4})
Smallest minority class has 4 samples. Setting k_neighbors for SMOTE to 3.
  - Resampled training distribution: Counter({np.int64(0): 21974, np.int64(4): 21974, np.int64(2): 21974, np.int64(1): 21974, np.int64(3): 21974})

PyTorch DataLoaders created successfully.

--- 7. Training and Evaluating on the initial split ---

PyTorch Improved CNN model created and moved to device.

Starting PyTorch model training with Early Stopping and LR Scheduler...
Epoch [1/100], Train Loss: 0.7033, Val Loss: 1.1587, Val Accuracy: 51.56%
Epoch [2/100], Train Loss: 0.4292, Val Loss: 1.2273, Val Accuracy: 51.39%
Epoch [3/100], Train Loss: 0.3517, Val Loss: 1.0639, Val Accuracy: 62.45%
Epoch [4/100], Train Loss: 0.3015, Val Loss: 1.0803, Val Accuracy: 59.03%
Epoch [5/100], Train Loss: 0.2737, Val Loss: 1.0417, Val Accuracy: 60.50%
Epoch [6/100], Train Loss: 0.2497, Val Loss: 0.8700, Val Accuracy: 67.75%
Epoch [7/100], Train Loss: 0.2302, Val Loss: 0.9283, Val Accuracy: 65.56%
Epoch [8/100], Train Loss: 0.2124, Val Loss: 0.9802, Val Accuracy: 65.49%
Epoch [9/100], Train Loss: 0.1941, Val Loss: 1.0780, Val Accuracy: 61.84%
Epoch [10/100], Train Loss: 0.1799, Val Loss: 0.8257, Val Accuracy: 70.92%
Epoch [11/100], Train Loss: 0.1689, Val Loss: 0.9031, Val Accuracy: 69.59%
Epoch [12/100], Train Loss: 0.1610, Val Loss: 0.8934, Val Accuracy: 71.04%
Epoch [13/100], Train Loss: 0.1498, Val Loss: 0.9308, Val Accuracy: 70.20%
Epoch [14/100], Train Loss: 0.1464, Val Loss: 0.9703, Val Accuracy: 68.52%
Epoch [15/100], Train Loss: 0.1375, Val Loss: 0.8561, Val Accuracy: 72.95%
Epoch [16/100], Train Loss: 0.1374, Val Loss: 0.9231, Val Accuracy: 70.50%
Epoch [17/100], Train Loss: 0.0800, Val Loss: 0.8102, Val Accuracy: 77.03%
Epoch [18/100], Train Loss: 0.0698, Val Loss: 0.9812, Val Accuracy: 71.19%
Epoch [19/100], Train Loss: 0.0654, Val Loss: 0.9950, Val Accuracy: 71.16%
Epoch [20/100], Train Loss: 0.0627, Val Loss: 0.9506, Val Accuracy: 73.93%
Epoch [21/100], Train Loss: 0.0603, Val Loss: 0.9534, Val Accuracy: 73.75%
Epoch [22/100], Train Loss: 0.0600, Val Loss: 0.9870, Val Accuracy: 72.31%
Epoch [23/100], Train Loss: 0.0576, Val Loss: 0.9858, Val Accuracy: 72.36%
Epoch [24/100], Train Loss: 0.0476, Val Loss: 0.9856, Val Accuracy: 72.16%
Epoch [25/100], Train Loss: 0.0461, Val Loss: 0.9937, Val Accuracy: 73.54%
Epoch [26/100], Train Loss: 0.0448, Val Loss: 0.9429, Val Accuracy: 75.09%
Epoch [27/100], Train Loss: 0.0443, Val Loss: 0.9694, Val Accuracy: 73.94%
Epoch [28/100], Train Loss: 0.0438, Val Loss: 0.9481, Val Accuracy: 74.69%
Epoch [29/100], Train Loss: 0.0431, Val Loss: 0.9642, Val Accuracy: 74.19%
Epoch [30/100], Train Loss: 0.0415, Val Loss: 0.9741, Val Accuracy: 74.45%
Epoch [31/100], Train Loss: 0.0414, Val Loss: 0.9555, Val Accuracy: 73.78%
Epoch [32/100], Train Loss: 0.0410, Val Loss: 0.9707, Val Accuracy: 74.50%
Epoch [33/100], Train Loss: 0.0405, Val Loss: 0.9655, Val Accuracy: 74.91%
Epoch [34/100], Train Loss: 0.0400, Val Loss: 0.9432, Val Accuracy: 75.62%
Epoch [35/100], Train Loss: 0.0410, Val Loss: 0.9558, Val Accuracy: 74.58%
Epoch [36/100], Train Loss: 0.0410, Val Loss: 0.9565, Val Accuracy: 75.33%
Epoch [37/100], Train Loss: 0.0405, Val Loss: 0.9816, Val Accuracy: 73.26%
Early stopping triggered

Model training complete. Loading best model weights...

Classification Report (Initial Split)
---------------------------------------
                     precision    recall  f1-score   support

             Normal       0.85      0.89      0.87      6232
  Obstructive Apnea       0.00      0.00      0.00        36
    Hypopnea Events       0.04      0.02      0.03       335
Central/Mixed Apnea       0.00      0.00      0.00         2
       Desaturation       0.29      0.25      0.27       889

           accuracy                           0.77      7494
          macro avg       0.24      0.23      0.23      7494
       weighted avg       0.74      0.77      0.76      7494


Confusion Matrix (Initial Split)
--------------------------------

--- 8. Starting Leave-One-Night-Out Cross-Validation ---
--- FOLD 1/9 (Testing on Night: 04-04-2025) ---
  - Original training distribution: Counter({np.int64(0): 25023, np.int64(4): 2182, np.int64(2): 1000, np.int64(1): 135, np.int64(3): 6})
  - Smallest minority class has 6 samples. Setting k_neighbors for SMOTE to 5.
  - Resampled training distribution: Counter({np.int64(0): 25023, np.int64(2): 25023, np.int64(4): 25023, np.int64(1): 25023, np.int64(3): 25023})
  - Training complete for fold 1.
  - Evaluation complete for fold 1.

--- FOLD 2/9 (Testing on Night: 05-04-2025) ---
  - Original training distribution: Counter({np.int64(0): 25862, np.int64(4): 1816, np.int64(2): 824, np.int64(1): 125, np.int64(3): 6})
  - Smallest minority class has 6 samples. Setting k_neighbors for SMOTE to 5.
  - Resampled training distribution: Counter({np.int64(0): 25862, np.int64(4): 25862, np.int64(2): 25862, np.int64(1): 25862, np.int64(3): 25862})
  - Early stopping triggered at epoch 33.
  - Training complete for fold 2.
  - Evaluation complete for fold 2.

--- FOLD 3/9 (Testing on Night: 08-05-2025) ---
  - Original training distribution: Counter({np.int64(0): 25284, np.int64(4): 2166, np.int64(2): 890, np.int64(1): 146, np.int64(3): 6})
  - Smallest minority class has 6 samples. Setting k_neighbors for SMOTE to 5.
  - Resampled training distribution: Counter({np.int64(0): 25284, np.int64(4): 25284, np.int64(2): 25284, np.int64(1): 25284, np.int64(3): 25284})
  - Training complete for fold 3.
  - Evaluation complete for fold 3.

--- FOLD 4/9 (Testing on Night: 10-05-2025) ---
  - Original training distribution: Counter({np.int64(0): 24752, np.int64(4): 2336, np.int64(2): 992, np.int64(1): 115, np.int64(3): 6})
  - Smallest minority class has 6 samples. Setting k_neighbors for SMOTE to 5.
  - Resampled training distribution: Counter({np.int64(0): 24752, np.int64(4): 24752, np.int64(2): 24752, np.int64(1): 24752, np.int64(3): 24752})
  - Early stopping triggered at epoch 92.
  - Training complete for fold 4.
  - Evaluation complete for fold 4.

--- FOLD 5/9 (Testing on Night: 11-05-2025) ---
  - Original training distribution: Counter({np.int64(0): 24699, np.int64(4): 2353, np.int64(2): 952, np.int64(1): 120, np.int64(3): 6})
  - Smallest minority class has 6 samples. Setting k_neighbors for SMOTE to 5.
  - Resampled training distribution: Counter({np.int64(0): 24699, np.int64(4): 24699, np.int64(2): 24699, np.int64(1): 24699, np.int64(3): 24699})
  - Early stopping triggered at epoch 81.
  - Training complete for fold 5.
  - Evaluation complete for fold 5.

--- FOLD 6/9 (Testing on Night: 16-04-2025) ---
  - Original training distribution: Counter({np.int64(0): 24888, np.int64(4): 2312, np.int64(2): 883, np.int64(1): 129, np.int64(3): 6})
  - Smallest minority class has 6 samples. Setting k_neighbors for SMOTE to 5.
  - Resampled training distribution: Counter({np.int64(0): 24888, np.int64(4): 24888, np.int64(2): 24888, np.int64(1): 24888, np.int64(3): 24888})
  - Early stopping triggered at epoch 85.
  - Training complete for fold 6.
  - Evaluation complete for fold 6.

--- FOLD 7/9 (Testing on Night: 24-04-2025) ---
  - Original training distribution: Counter({np.int64(0): 25062, np.int64(4): 2200, np.int64(2): 854, np.int64(1): 147, np.int64(3): 2})
  - Smallest minority class has 2 samples. Setting k_neighbors for SMOTE to 1.
  - Resampled training distribution: Counter({np.int64(0): 25062, np.int64(4): 25062, np.int64(2): 25062, np.int64(1): 25062, np.int64(3): 25062})
  - Early stopping triggered at epoch 93.
  - Training complete for fold 7.
  - Evaluation complete for fold 7.

--- FOLD 8/9 (Testing on Night: 25-04-2025) ---
  - Original training distribution: Counter({np.int64(0): 24318, np.int64(4): 2295, np.int64(2): 909, np.int64(1): 141, np.int64(3): 4})
  - Smallest minority class has 4 samples. Setting k_neighbors for SMOTE to 3.
  - Resampled training distribution: Counter({np.int64(0): 24318, np.int64(4): 24318, np.int64(2): 24318, np.int64(1): 24318, np.int64(3): 24318})
  - Early stopping triggered at epoch 38.
  - Training complete for fold 8.
  - Evaluation complete for fold 8.

--- FOLD 9/9 (Testing on Night: 26-04-2025) ---
  - Original training distribution: Counter({np.int64(0): 25760, np.int64(4): 2340, np.int64(2): 968, np.int64(1): 150, np.int64(3): 6})
  - Smallest minority class has 6 samples. Setting k_neighbors for SMOTE to 5.
  - Resampled training distribution: Counter({np.int64(0): 25760, np.int64(4): 25760, np.int64(2): 25760, np.int64(1): 25760, np.int64(3): 25760})
  - Early stopping triggered at epoch 83.
  - Training complete for fold 9.
  - Evaluation complete for fold 9.


====================================================
Leave-One-Night-Out Cross-Validation Complete.
Aggregated Results Across All Folds:
====================================================
                     precision    recall  f1-score   support

             Normal       0.98      0.97      0.98     56088
  Obstructive Apnea       0.81      0.89      0.85       324
    Hypopnea Events       0.76      0.89      0.82      3015
Central/Mixed Apnea       0.43      0.89      0.58        18
       Desaturation       0.88      0.91      0.90      8001

           accuracy                           0.96     67446
          macro avg       0.77      0.91      0.82     67446
       weighted avg       0.96      0.96      0.96     67446

======================================================
Job finished at Thu 24 Jul 23:09:39 BST 2025
======================================================
